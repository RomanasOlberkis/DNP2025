@page "/"
@using ApiContracts
@using BlazorApp.Services
@inject IPostService PostService
@inject NavigationManager NavMgr

<PageTitle>Forum Home</PageTitle>

<h1>Forum Posts</h1>

<AuthorizeView>
    <Authorized>
        <div class="alert alert-info">
            Welcome, @context.User.Identity!.Name!

</div>
    </Authorized>
    <NotAuthorized>
        <div class="alert alert-warning">
            You are not logged in. <a href="/login">Login here</a>
        </div>
    </NotAuthorized>
</AuthorizeView>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (posts == null)
{
    <p>Loading posts...</p>
}
else if (!posts.Any())
{
    <p>No posts available.</p>
}
else
{
    <div class="mb-3">
        <input type="text" class="form-control" placeholder="Search by title..." @bind="searchTitle" @bind:event="oninput" />
    </div>

    <div class="list-group">
        @foreach (var post in FilteredPosts)
        {
            <a href="/posts/@post.Id" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">@post.Title</h5>
                    <small>by @post.UserName</small>
                </div>
            </a>
        }
    </div>
}

<div class="mt-3">
    <AuthorizeView>
        <Authorized>
            <button class="btn btn-primary" @onclick="() => NavMgr.NavigateTo(\"/posts/create\")">Create New Post</button>
        </Authorized>
        <NotAuthorized>
            <button class="btn btn-secondary" @onclick="() => NavMgr.NavigateTo(\"/users/create\")">Register User</button>
            <button class="btn btn-primary" @onclick="() => NavMgr.NavigateTo(\"/login\")">Login</button>
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private IEnumerable<PostDto>? posts;
    private string errorMessage = string.Empty;
    private string searchTitle = string.Empty;

    private IEnumerable<PostDto> FilteredPosts
    {
        get
        {
            if (posts == null) return Enumerable.Empty<PostDto>();
            if (string.IsNullOrEmpty(searchTitle)) return posts;
            return posts.Where(p => p.Title.Contains(searchTitle, StringComparison.OrdinalIgnoreCase));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadPostsAsync();
    }

    private async Task LoadPostsAsync()
    {
        try
        {
            posts = await PostService.GetPostsAsync();
        }
        catch (Exception e)
        {
            errorMessage = $"Error loading posts: {e.Message}";
        }
    }
}